<!--  input.html -->

{% extends "base.html" %}
{% block body %}

	<div class="maindiv">
		<input class="megainput urlinput" type="text" placeholder="url __" 
				onfocus="onfocusHandler(this)" 
				onblur="onblurHandler(this)" 
				onkeyup="getMeta(this.value)"/>

		<div class="metainfo">	
			<div class="kolonne1">
				<div style="display:flex;">
					<div id="domain"></div> 
					<img id="favicon" width="25px" height="25px" src="#"/>
				</div>
				<div id="description"></div>
			</div>
			<div class="kolonne2">
				<div id="topics"></div>
				<div id="top"><input type="text" placeholder="Main-topic"/></div>
				<div id="sub"><input type="text" placeholder="Sub-topic"/></div>
			</div>
			<img class="plusicon" width="100px" height="100px" src="static/plus-icon.png" onclick="postUrl()"/>
		</div>


	<div class="maindiv">
		<input class="megainput searchinput" type="text" placeholder="search __" 
		       onfocus="onfocusHandler(this)" 
		       onblur="onblurHandler(this)" 
		       onkeyup="search(this.value)"/>

		<table class="tableview">
			<thead>
				<th></th>
				<th></th>
				<th></th>
			</thead>
			<tbody>
					
			</tbody>
		</table> 
	</div>



<script type="text/javascript">

	/* Initiating a global APP-object. This object is supposed to hold
	  all variables that otherwise would be global.
	  By doing it like this we end having just 1 global variable named
	   APP. And all other variables are APP.somevariable. 
	   GLOBAL variables are evil, thats why we do it. - Jonas */

	REGEX = {

		urlpattern1 : /(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/,
		urlpattern2 : /^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i
	};

	APP = {
		$urlinput : $('.urlinput'),
		$searchinput : $('.searchinput'),
		$metainfo : $('.metainfo'),
		$tbody : $('.tableview tbody'),
		old_url : '',
		old_title : '',
		old_favicon : '',
		meta : '',
		links : {}
	};

	function onblurHandler(element){
		var $ele = $(element);

		if ($ele.hasClass('urlinput')){
			$ele.attr('placeholder', 'url __');
			$ele.val(APP.old_title);
		} else {
			$ele.attr('placeholder', 'search __');
		};
	};

	function onfocusHandler(element){
		var $ele = $(element);

		$ele.attr('placeholder', '');
		if ($ele.hasClass('urlinput')){
			$ele.val(APP.old_url);
		} else {
			$ele.val('');
		};
	};

	// View1 - Constructs a list-view of all links.
	function constructTable(){
		var thtml;
		var links = APP.links;

		var i = 0;
		for (var link in links){
			console.log(links[link]);

			if (links[link]['favicon']){
				le_link = links[link]['favicon'];
			} else {
				le_link = 'static/chrome-512.png';
			};

			thtml = '<tr>'+
						'<td><img width="40px" height="40px" src="'+ le_link +'"/></td>'+
						'<td>'+links[link]['title']+'</td>'+
						'<td><a id="link'+i+'" class="linkholder" href="#"><img width="25px" height="25px" src="static/external_link.png"/></a></td>'+
					'</tr>';
			APP.$tbody.append(thtml);
			$('#link'+i).attr('href', links[link]['url']);
			i ++;
		};
		return 0;
	}

	function resetInput(){
		APP.old_title = '';
		APP.old_url = '';
		APP.$urlinput.val('');
		APP.$metainfo.hide();
	};

	// --- AJAX request functions ---

	function postUrl(){
		// Debug
		//console.log('Url:' + APP.old_url+'Meta:'+ JSON.stringify(APP.meta));
		json_data = {
			 'url' : APP.old_url, 
			 'meta' : APP.meta 
		};

		$.ajax('/postmeta', {
				data : JSON.stringify(json_data),
    			contentType : 'application/json',
    			type : 'POST',
    			success: function(data){ 
    				console.log(data.status);
    				APP.links = data.links;
    				resetInput();
    				APP.$tbody.html('');
    				constructTable();
    				
    			},
				error : function(xhr){ console.log(xhr.status);}
				});
	};

	function getMeta(iurl){
		var title;

		// Reset page if url is empty
		if (iurl === ''){
			resetInput();
			return 0;
		};

		console.log(iurl);

		if (iurl != APP.old_url && REGEX.urlpattern2.test(iurl)){
			console.log('Valid URL entered!');
			APP.old_url = iurl;

			$.post('/fetchmeta', { 'url': iurl}, 

				function(data){
					if(data.meta){
						var meta = data.meta;
						console.log('Status: ' + data.status);
						
						// SHOW metadata
						APP.$urlinput.val(meta.title);
						$('#favicon').attr('src', meta.favicon);
						$('#domain').html(meta.domain);
						$('#description').html('Description:' + meta.description);
						$('#topics').html('<div>'+meta.main_topic+'</div><div>topic2</div><div>topic3</div>');
						APP.$metainfo.show();

						// CACHE data for later
						APP.old_title = meta.title;
						APP.old_favicon = meta.favicon;
						APP.meta = meta;

						// Blur the input-field to notify the user that a correct url has been entered.
						APP.$urlinput.blur();
					} else {
						console.log('Status: ' + data.status);
					};
				}
			);
		};
	};

	// Not active
	function search(istring) {

		console.log(istring);
		return 0;
	};

	// Init function
	$(document).ready(function(){

		APP.$metainfo.hide();

		$.get('/fetchlinks', function(data){
			console.log('Status:' + data.status)
			APP.links = data.links;
			constructTable();
		});
	});

</script>
{% endblock %}



