<!--  input.html -->

{% extends "base.html" %}
{% block body %}

	<div class="maindiv">
		<input id="urlinput" class="megainput urlinput" type="text" placeholder="url __"
				onfocus="onfocusHandler(this)" 
				onblur="onblurHandler(this)" 
				onkeyup="getMeta(this.value)" 
				onclick="this.select()"/>

		<div class="metainfo">	

			<div class="kolonne1">
				<div style="display:flex;">
					<img id="favicon" width="25px" height="25px" src="#"/>
					<div id="domain">
					</div> 
				</div>
				<h3>Description:</h3>
				<div id="description"></div>
			</div>

			<div class="kolonne2">
				<input id="maintopicinput" class="topicinput maintopic" type="text" placeholder="Main topic"/>
				<input id="subtopicinput" class="topicinput subtopic" type="text" placeholder="Sub topic"/>
			</div>
			<div>
				<img class="plusicon" width="100px" height="100px" 
				     src="static/plus-icon.png" onclick="postMeta()"/>
			</div>
		</div>


	<div class="maindiv">
		<input id="searchinput" class="megainput searchinput" type="text" placeholder="search __" 
		       onfocus="onfocusHandler(this)" 
		       onblur="onblurHandler(this)" 
		       onkeyup="search(this.value)"/>

		<nav style="display: flex; margin-bottom: 30px;">
			<a href="/maps"><button>Maps</button></a>
			<a href="/meny"><button>Meny</button></a>
		</nav>

		<table class="tableview">
			<thead>
				<th></th>
				<th></th>
				<th></th>
			</thead>
			<tbody>
					
			</tbody>
		</table> 
	</div>
	

<script type="text/javascript">

	/* Initiating a global APP-object. This object is supposed to hold
	  all variables that otherwise would be global.
	  By doing it like this we end having just 1 global variable named
	   APP. And all other variables are APP.somevariable. 
	   GLOBAL variables are evil, thats why we do it. - Jonas */


	APP = {
		$urlinput : $('.urlinput'),
		$searchinput : $('.searchinput'),
		$metainfo : $('.metainfo'),
		$tbody : $('.tableview tbody'),
		$maintop : $('.maintopic'),
		$subtop : $('.subtopic'),
		old_url : '',
		old_title : '',
		old_favicon : '',
		meta : '',
		links : {},
	}; 

	function onblurHandler(element){
		var $ele = $(element);

		if ($ele.hasClass('urlinput')){
			$ele.attr('placeholder', 'url __');
			$ele.val(APP.old_title);
		} else {
			$ele.attr('placeholder', 'search __');
		};
	};

	function onfocusHandler(element){
		var $ele = $(element);
		$ele.attr('placeholder', '');
		if ($ele.hasClass('urlinput')){
			$ele.val(APP.old_url);
		} else {
			$ele.val('');
		};
	};

	function resetInput(){
		APP.old_title = '';
		APP.old_url = '';
		APP.$urlinput.val('');
		APP.$metainfo.hide();
	};


	// --- AJAX request functions ---

	function postMeta(){	
	/*
		postMeta() blir trigget av en onclick=""-event 
		 på class="plusicon".
		
		Denne funksjonen reagerer på 5 måter:
		
		0 - Skjekke om begge input-feltene for maintopic og subtopic er utfylt.
		1 - sende en /postmeta med metainformasjon om urlen inkl url.
		2 - sende en /updatemap med maintopic og subtopic + url.
		3 - clear input område for å signaliserer at url-en har blitt submitted.
		4 - update liste med urler slik at den nye url-en dukker opp i listen.

		Det er viktig at post1 skjer først, deretter post2, 
		 men bare dersom post1 lyktes.
		Det er for å være sikker på at url-en som blir lagret i map-modellen
		 allerede finnes i url-databasen.
		----------------------------------------------------- jonas --- */

		// First of all, check if both topic-fields have a value.
		// Display necesarry alerts to the user.

		if(APP.$maintop.val() === '' || APP.$subtop.val() === ''){
			console.log('Fill in both topic fields.');
			APP.$maintop.attr('placeholder', 'Required field');
			APP.$subtop.attr('placeholder', 'Required field');
			return 0;
		};

		var json_meta = {
			url : APP.old_url, 
			meta : APP.meta 
		};

		var json_topics = {
			url : APP.old_url,
			main_topic : APP.$maintop.val(),
			subtopic : APP.$subtop.val()
		};

		// Post 1 
		$.ajax('/postmeta', {
			data : JSON.stringify(json_meta),
			contentType : 'application/json',
			type : 'POST',
			success: function(data){ 
				console.log(data.status);
				SEARCHDATA = data.searchdata;

				resetInput();
				APP.$tbody.html('');
				fillTable_2d(APP.$tbody, SEARCHDATA);

				// Post 2 
				$.ajax('/updatemap', {
					data : JSON.stringify(json_topics),
					contentType : 'application/json',
					type : 'POST',
					success : function(data){
						console.log(data.status);
						},
					error : function(data){
						console.log('Status:'+data.status); 
					}
				});
			},
			error : function(xhr){ 
				console.log(xhr.status);
			}
		});
	};


	function getMeta(iurl){

		var title;

		// Reset page if url is empty
		if (iurl === ''){
			resetInput();
			return 0;
		};

		console.log(iurl);

		if (iurl != APP.old_url && REGEX.urlpattern2.test(iurl)){

			console.log('Valid URL entered!');
			APP.old_url = iurl;
			APP.$metainfo.show();
			APP.$urlinput.val("fetching title and metadata...");

			$.post('/fetchmeta', { 'url': iurl}, 

				function(data){
					if(data.meta){
						var meta = data.meta;
						console.log('Url: ' + data.status);
						
						// SHOW metadata
						APP.$urlinput.val(meta.title);
						$('#favicon').attr('src', meta.favicon);
						$('#domain').html(meta.domain);
						$('#description').html(meta.description);
						

						// CACHE data for later
						APP.old_title = meta.title;
						APP.old_favicon = meta.favicon;
						APP.meta = meta;

						// Blur the input-field to notify the user that a correct url has been entered.
						APP.$urlinput.blur();
					} else {
						console.log('Status: ' + data.status);
					};
				}
			);
		};
	};


	// Not active
	function search(istring) {

		var resultdata = [];
		resultdata = generalSearch(SEARCHDATA, istring);
		APP.$tbody.html('');
		fillTable_2d(APP.$tbody, resultdata);

		return 0;
	};

	
	function fillTable_dict(linksdict){
		// Depreciated funciton
		// Viewfunction 1 - Fills a list-view of all url-links.
		// INPUT a dictionary like -> links[link][data]

		var thtml;
		var links = linksdict;

		var i = 0;
		for (var link in links){

			if (links[link]['favicon']){
				le_link = links[link]['favicon'];
			} else {
				le_link = 'static/chrome-512.png';
			};

			thtml = '<tr>'+
						'<td><img width="40px" height="40px" src="'+ le_link +'"/></td>'+
						'<td>'+links[link]['title']+'</td>'+
						'<td><a id="link'+i+'" class="linkholder" href="#"><img width="25px" height="25px" src="static/external_link.png"/></a></td>'+
					'</tr>';
			APP.$tbody.append(thtml);
			$('#link'+i).attr('href', links[link]['url']);
			i ++;
		};
		return 0;
	};


// ----------- MAIN INIT -------- 
	$(document).ready(function(){

		APP.$metainfo.hide();

		$.post('/fetchsearchdata', 

			function(data){
				console.log(data.status);
				if (data.status === 'Search OK'){
					SEARCHDATA = data.searchdata;
					fillTable_2d(APP.$tbody, SEARCHDATA);
				} else {
					console.log(data.status + data.error);
				};
			}	
		);

		// building taglist for autocompletion
		$.get('/tags', 
			function(data){
				APP.tags = data.tags;
				$( "#maintopicinput" ).autocomplete({
					source: APP.tags
				});
				$( "#subtopicinput" ).autocomplete({
					source: APP.tags
				});
				$( "#searchinput" ).autocomplete({
					source: APP.tags
				});
			}
		);

	});

</script>
{% endblock %}



